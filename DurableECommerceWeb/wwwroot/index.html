<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Durable Functions Shop</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
</head>
<body>

    <div class="text-center bg-light" style="margin-bottom:0">
        <h1>Durable Functions Demo Shop</h1>
        <p>Buy a training course!</p>
    </div>
    <div class="container">

        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <img class="card-img-top" src="images/strat.jpg" alt="Guitar">
                    <div class="card-body">
                        <h4 class="card-title">Performance Tuning</h4>
                        <p class="card-text">Some example text.</p>
                        <a href="#" data-product="performance-tuning"
                           data-price="2000" class="btn btn-primary purchase">Buy now</a>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <img class="card-img-top" src="images/football.jpg" alt="Football">
                    <div class="card-body">
                        <h4 class="card-title">Achieving Your Goals</h4>
                        <p class="card-text">Some example text.</p>
                        <a href="#" data-product="achieving-your-goals"
                           data-price="400" class="btn btn-primary purchase">Buy now</a>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <img class="card-img-top" src="images/cakes.jpg" alt="Cakes">
                    <div class="card-body">
                        <h4 class="card-title">Cake Driven Development</h4>
                        <p class="card-text">Some example text.</p>
                        <a href="#" data-product="cake-driven-development"
                           data-price="50" class="btn btn-primary purchase">Buy now</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div id="message"></div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <h3>Check Order Status</h3>
                <a href="#" class="btn btn-primary" id="checkStatusButton">Check</a>
            </div>
            <div class="col-md-6">
                <h3>Approve order</h3>
                <a href="#" data-approvalStatus="Approved" class="btn btn-success approveButton">Approve</a>
                <a href="#" data-approvalStatus="Rejected" class="btn btn-danger rejectButton">Reject</a>
            </div>
        </div>
    </div>

    <script>
        let orderId = -1;
        const postData = (url = ``, data = {}) => {
            // Default options are marked with *
            return fetch(url, {
                method: "POST", // *GET, POST, PUT, DELETE, etc.
                mode: "no-cors", // no-cors, cors, *same-origin
                cache: "no-cache", // *default, no-cache, reload, force-cache, only-if-cached
                credentials: "same-origin", // include, same-origin, *omit
                headers: {
                    "Content-Type": "application/json; charset=utf-8",
                    // "Content-Type": "application/x-www-form-urlencoded",
                },
                redirect: "follow", // manual, *follow, error
                referrer: "no-referrer", // no-referrer, *client
                body: JSON.stringify(data), // body data type must match "Content-Type" header
            })
            .then(response => response.json()) // parses response to JSON
        };

        function orderCreated(orderInfo, product) {
            orderId = orderInfo.id;
            const messageDiv = document.getElementById("message");
            messageDiv.classList.add("alert", "alert-success");
            messageDiv.innerHTML = `<strong>Great choice!</strong> Thank you for purchasing <strong>${product}</strong>. Your order number is <strong>${orderId}</strong>`;
        }

        function purchaseItem(event) {
            const product = event.target.dataset.product;
            const price = event.target.dataset.price;
            console.log(`purchased a ${product} for ${price}`);
            postData(`/api/CreateOrder`, { ProductId: product, Amount: price })
                .then(data => orderCreated(data, product))
                .catch(error => console.dir(error));
        }
        function approve(event) {
            event.preventDefault();
            const status = event.target.dataset.approvalStatus;
            postData(`/api/approve/${orderId}`, status)
        }

        function checkStatus(event) {
            event.preventDefault();
            fetch(`/api/orderstatus/${orderId}`)
                .then(response => response.json())
                .then(json => console.log(json))
        }

        const purchaseButtons = Array.from(document.querySelectorAll('.purchase'));
        Array.prototype.forEach.call(purchaseButtons, b => b.addEventListener('click', purchaseItem));
        const approvalButtons = Array.from(document.querySelectorAll('.approveButton'));
        Array.prototype.forEach.call(approvalButtons, b => b.addEventListener('click', approve));
        document.querySelector('#checkStatusButton').addEventListener('click', checkStatus);
    </script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Durable Functions Shop</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
</head>
<body>

<div class="text-center bg-light mb-0">
    <h1>Order Status</h1>
</div>
<div id="app" class="container">

    <div class="row">

        <!-- If you use a BS4 row, it should then contain one or more grid columns -->

        <form class="form-inline">
            <label class="sr-only" for="inputOrderNumber">Order Number</label>
            <input type="text" v-model="orderId" class="form-control" id="inputOrderNumber" placeholder="Order Number">
            <button type="submit" class="btn btn-primary ml-2" @click="checkStatus">Check</button>
        </form>
    </div>
    <div class="row" v-if="errorMessage"><!-- If you use a BS4 row, it should then contain one or more grid columns -->
        <div class="alert alert-danger">
            {{errorMessage}}
        </div>
    </div>
    <div class="row"><!-- If you use a BS4 row, it should then contain one or more grid columns -->

        <!-- There is a v-if="orderStatus" on the div and the <order-status>. Don't think you need both -->
        <div v-if="orderStatus">
            <order-status v-if="orderStatus" :order-status="orderStatus"></order-status>
        </div>
    </div>

    <!-- Do you need a new row for this? Adding in the above <div v-if="orderStatus"> will make below v-if simpler -->
    <div class="row">
        <div class="col-md-6" v-if="orderStatus && orderStatus.customStatus === 'Needs approval'">
            <h3>Approve order</h3>
            <a href="#" data-approvalStatus="Approved" class="btn btn-success approveButton" @click="approve">Approve</a>
            <a href="#" data-approvalStatus="Rejected" class="btn btn-danger rejectButton" @click="approve">Reject</a>
        </div>
    </div>
</div>

<template id="orderStatusTemplate">

            <table class="table table-striped mt-2">
                <tbody>
                    <tr>
                        <td><strong>Product Id: </strong></td>
                        <td>{{orderStatus.input.ProductId}}</td>
                    </tr>
                    <tr v-if="orderStatus.input.PurchaserEmail">
                        <td><strong>Purchaser Email: </strong></td>
                        <td>{{orderStatus.input.PurchaserEmail}}</td>
                    </tr>
                    <tr>
                        <td><strong>Created Time: </strong></td>
                        <td>{{orderStatus.createdTime | formatDateTime}}</td>
                    </tr>
                    <tr>
                        <td><strong>Last Updated: </strong></td>
                        <td>{{orderStatus.lastUpdatedTime | formatDateTime}}</td>
                    </tr>
                    <tr>
                        <td><strong>Runtime Status: </strong></td>
                        <td>{{orderStatus.runtimeStatus | formatRuntimeStatus}}</td>
                    </tr>
                    <tr v-if="orderStatus.customStatus">
                        <td><strong>Custom Status: </strong></td>
                        <td>{{orderStatus.customStatus}}</td>
                    </tr>
                <!-- Be good to align these <tr> with the others -->
                <tr v-if="orderStatus.output">
                    <td><strong>Status: </strong></td>
                    <td>{{orderStatus.output.Status}}</td>
                </tr>
                <tr v-if="orderStatus.output.Pdf">
                    <td><strong>Downloads: </strong></td>
                    <td><a class="btn btn-primary" :href="orderStatus.output.Pdf">PDF</a>
                        <a class="btn btn-primary" :href="orderStatus.output.Video">Video</a>
                    </td>
                </tr>
                </tbody>

            </table>

</template>

<script>
    // get a query string parameter https://stackoverflow.com/a/901144/7532

    // Can this code be moved to the bottom of the <script>? Want to focus on the Vue code / have this first?
    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, '\\$&');
        var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    function getOrderId() {
        const id = getParameterByName('id');
        if (id) return id;
        var pathArray = window.location.pathname.split('/');
        return pathArray[pathArray.length - 1];
    }

    Vue.filter('formatDateTime',
        function(value) {
            const d = new Date(value);
            return d.toLocaleString();
        });

    Vue.filter('formatRuntimeStatus',
        function (value) {
            return ["Running", "Completed", "ContinuedAsNew", "Failed", "Canceled", "Terminated", "Pending"][value];
        });

    Vue.component('order-status',
        {
            props: ['orderStatus'],
            template: '#orderStatusTemplate'
        });

    const postData = (url = '', data = {}) => {
        // Default options are marked with *
        return fetch(url,
                {
                    method: "POST", // *GET, POST, PUT, DELETE, etc.
                    mode: "no-cors", // no-cors, cors, *same-origin
                    cache: "no-cache", // *default, no-cache, reload, force-cache, only-if-cached
                    credentials: "same-origin", // include, same-origin, *omit
                    headers: {
                        "Content-Type": "application/json; charset=utf-8"
                    },
                    redirect: "follow", // manual, *follow, error
                    referrer: "no-referrer", // no-referrer, *client
                    body: JSON.stringify(data) // body data type must match "Content-Type" header
                })
            .then(response => response.json()); // parses response to JSON
    };

    var app = new Vue({
        el: '#app',
        data: {
            orderId: null,
            orderStatus: null,
            errorMessage: null
        },
        mounted: function () {
            this.orderId = getOrderId();
            this.checkStatus();
        },

        methods: {
            checkStatus: function (event) { // Can use ES6 arrow function
                if (event) event.preventDefault(); // Any need for this line? Function only called from "mounted"?
                this.errorMessage = null;
                this.orderStatus = null;
                fetch(`/api/orderstatus/${this.orderId}`)
                    .then(response => {
                            if (response.status === 404) {
                                this.errorMessage = "Order " + this.orderId + " not found";
                            } else {
                                response.json().then(json => this.orderStatus = json);
                            }
                        }
                    )
                    .catch(err => console.dir(err)); // Is it better to use console.error here?
            },
            approve: function(event) {
                // Should error message be cleared here and set if there was an approve HTTP request error?
                const status = event.target.dataset.approvalStatus;
                postData(`/api/approve/${this.orderId}`, status);
            }
        }
    });
    </script>
</body>
</html>